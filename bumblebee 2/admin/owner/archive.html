<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bumblebee â€” Archives</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Montserrat:wght@200;300;400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="../admin.css"/>
<style>
.archive-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-bottom:28px}
.search-bar{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.search-input{flex:1;min-width:200px;background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--white);padding:11px 16px;font-family:'Montserrat',sans-serif;font-size:.65rem;outline:none;transition:border-color .3s}
.search-input:focus{border-color:rgba(201,168,76,.35)}
.search-input::placeholder{color:var(--gray)}
.date-filter{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.date-input{background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--white);padding:10px 12px;font-family:'Montserrat',sans-serif;font-size:.6rem;outline:none;transition:border-color .3s}
.date-input:focus{border-color:rgba(201,168,76,.35)}
.date-label{font-size:.5rem;letter-spacing:.25em;text-transform:uppercase;color:var(--gray)}
</style>
</head>
<body>
<div class="sidebar-overlay" id="overlay" onclick="closeSidebar()"></div>
<div class="toast" id="toast"></div>

<div class="admin-layout">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo">Bumble<span>bee</span></div>
      <div class="role-badge">ğŸ‘‘ PropriÃ©taire</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Principal</div>
      <a class="nav-item" href="dashboard.html"><span class="nav-icon">ğŸ“Š</span>Dashboard</a>
      <a class="nav-item" href="orders.html"><span class="nav-icon">ğŸ§¾</span>Commandes</a>
      <a class="nav-item" href="reservations.html"><span class="nav-icon">ğŸ“…</span>RÃ©servations</a>
      <div class="nav-section">Gestion</div>
      <a class="nav-item" href="inventory.html"><span class="nav-icon">ğŸ“¦</span>Inventaire</a>
      <a class="nav-item" href="matches.html"><span class="nav-icon">âš½</span>Matchs</a>
      <a class="nav-item" href="customers.html"><span class="nav-icon">ğŸ‘¥</span>Clients</a>
      <a class="nav-item" href="staff.html"><span class="nav-icon">ğŸ‘¤</span>Personnel</a>
      <a class="nav-item" href="archive.html"><span class="nav-icon">ğŸ—‚ï¸</span>Archives</a>
      <div class="nav-section">Site</div>
      <a class="nav-item" href="../../public/home.html" target="_blank"><span class="nav-icon">ğŸŒ</span>Voir le site</a>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="doLogout()">ğŸšª DÃ©connexion</button>
    </div>
  </aside>

  <div class="main-content">
    <header class="main-header">
      <button class="sidebar-toggle" onclick="openSidebar()">â˜°</button>
      <h1><em>Archives</em> â€” Historique complet</h1>
    </header>

    <div class="main-body">
      <!-- GLOBAL STATS -->
      <div class="archive-stats">
        <div class="stat-card"><div class="stat-icon">ğŸ§¾</div><div class="stat-val" id="total-orders">0</div><div class="stat-label">Commandes totales</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ’°</div><div><span class="stat-val" id="total-revenue">0</span><span class="stat-da">DA</span></div><div class="stat-label">Revenus totaux</div></div>
        <div class="stat-card"><div class="stat-icon">âœ…</div><div><span class="stat-val" id="total-paid">0</span><span class="stat-da">DA</span></div><div class="stat-label">Total encaissÃ©</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ“…</div><div class="stat-val" id="total-resas">0</div><div class="stat-label">RÃ©servations totales</div></div>
      </div>

      <!-- ORDERS ARCHIVE -->
      <div class="table-card" style="margin-bottom:24px">
        <div class="table-header">
          <div class="table-title">Historique <em>commandes</em></div>
        </div>
        <div style="padding:16px 20px;border-bottom:1px solid var(--border)">
          <div class="search-bar">
            <input type="text" class="search-input" id="search-orders" placeholder="Rechercher par nom, ID..." oninput="renderOrders()"/>
            <div class="date-filter">
              <span class="date-label">Du</span>
              <input type="date" class="date-input" id="date-from" onchange="renderOrders()"/>
              <span class="date-label">Au</span>
              <input type="date" class="date-input" id="date-to" onchange="renderOrders()"/>
            </div>
          </div>
          <div style="font-size:.54rem;color:var(--gray);letter-spacing:.1em" id="orders-count">â€” commandes trouvÃ©es</div>
        </div>
        <div class="orders-list" id="orders-list">
          <div class="empty-state"><div class="empty-icon">â³</div><div class="empty-msg">Chargement...</div></div>
        </div>
      </div>

      <!-- RESERVATIONS ARCHIVE -->
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">Historique <em>rÃ©servations</em></div>
        </div>
        <div class="orders-list" id="resas-list">
          <div class="empty-state"><div class="empty-icon">â³</div><div class="empty-msg">Chargement...</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from '../../firebase-config.js';
import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { collection, query, orderBy, getDocs, doc, getDoc }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href = '../login.html'; return; }
  const snap = await getDoc(doc(db,'users',user.uid));
  if (!snap.exists() || snap.data().role !== 'owner') { window.location.href = '../login.html'; return; }
  loadData();
});

window.openSidebar=()=>{document.getElementById('sidebar').classList.add('open');document.getElementById('overlay').classList.add('show');};
window.closeSidebar=()=>{document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('show');};
window.doLogout=async()=>{await signOut(auth);window.location.href='../login.html';};

let allOrders=[];
let allResas=[];

function fmt(ts){if(!ts)return 'â€”';const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleDateString('fr-DZ')+' '+d.toLocaleTimeString('fr-DZ',{hour:'2-digit',minute:'2-digit'});}

function statusBadge(s){
  const map={pending:'badge-pending',preparing:'badge-preparing',ready:'badge-ready',done:'badge-done',confirmed:'badge-confirmed',cancelled:'badge-cancelled',arrived:'badge-arrived'};
  const labels={pending:'En attente',preparing:'En prÃ©paration',ready:'PrÃªt',done:'TerminÃ©',confirmed:'ConfirmÃ©e',cancelled:'AnnulÃ©e',arrived:'ArrivÃ©'};
  return `<span class="badge ${map[s]||'badge-pending'}">${labels[s]||s}</span>`;
}

window.renderOrders=function(){
  const search=document.getElementById('search-orders').value.toLowerCase();
  const from=document.getElementById('date-from').value;
  const to=document.getElementById('date-to').value;
  let filtered=allOrders.filter(o=>{
    if(search&&!o.clientName?.toLowerCase().includes(search)&&!o.orderId?.toLowerCase().includes(search)) return false;
    if(from||to){const d=o.createdAt?.toDate?o.createdAt.toDate():new Date();const ds=d.toISOString().split('T')[0];if(from&&ds<from)return false;if(to&&ds>to)return false;}
    return true;
  });
  document.getElementById('orders-count').textContent=`${filtered.length} commande(s) trouvÃ©e(s)`;
  const el=document.getElementById('orders-list');
  if(filtered.length===0){el.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ§¾</div><div class="empty-msg">Aucune commande trouvÃ©e.</div></div>';return;}
  el.innerHTML=filtered.map(o=>`
    <div class="order-card">
      <div class="order-card-top">
        <span class="order-id">${o.orderId}</span>
        <span class="order-client">${o.clientName} Â· ${o.clientPhone}</span>
        <span class="order-time">${fmt(o.createdAt)}</span>
        ${statusBadge(o.status)}
        ${o.paid?'<span class="badge badge-paid">âœ… PayÃ©</span>':'<span class="badge badge-unpaid">âŒ Non payÃ©</span>'}
      </div>
      <div class="order-items-list">${(o.items||[]).map(i=>`â€¢ ${i.name} Ã—${i.qty} â€” ${i.price*i.qty} DA`).join('<br>')}</div>
      <div class="order-card-bottom">
        <span class="order-total">${o.total}<span class="da">DA</span></span>
      </div>
    </div>`).join('');
};

async function loadData(){
  const [ordSnap, resSnap] = await Promise.all([
    getDocs(query(collection(db,'orders'), orderBy('createdAt','desc'))),
    getDocs(query(collection(db,'reservations'), orderBy('createdAt','desc')))
  ]);
  allOrders = ordSnap.docs.map(d=>({id:d.id,...d.data()}));
  allResas = resSnap.docs.map(d=>({id:d.id,...d.data()}));

  // Global stats
  document.getElementById('total-orders').textContent = allOrders.length;
  document.getElementById('total-revenue').textContent = allOrders.reduce((s,o)=>s+(o.total||0),0);
  document.getElementById('total-paid').textContent = allOrders.filter(o=>o.paid).reduce((s,o)=>s+(o.total||0),0);
  document.getElementById('total-resas').textContent = allResas.length;

  renderOrders();

  // Reservations
  const el=document.getElementById('resas-list');
  if(allResas.length===0){el.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-msg">Aucune rÃ©servation.</div></div>';return;}
  el.innerHTML=allResas.map(r=>`
    <div class="order-card">
      <div class="order-card-top">
        <span class="order-id">${r.reservationId}</span>
        <span class="order-client">${r.clientName} Â· ${r.clientPhone}</span>
        <span class="order-time">${r.date} Â· ${r.time}</span>
        ${statusBadge(r.status)}
      </div>
      <div class="order-items-list">ğŸ‘¥ ${r.guests} pers. Â· ğŸª„ ${r.hookah||'â€”'}</div>
    </div>`).join('');
}
</script>
</body>
</html>