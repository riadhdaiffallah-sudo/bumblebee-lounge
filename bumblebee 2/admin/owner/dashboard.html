<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bumblebee â€” Dashboard PropriÃ©taire</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Montserrat:wght@200;300;400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="../admin.css"/>
</head>
<body>
<div class="sidebar-overlay" id="overlay" onclick="closeSidebar()"></div>
<div class="toast" id="toast"></div>

<div class="admin-layout">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo">Bumble<span>bee</span></div>
      <div class="role-badge">ğŸ‘‘ PropriÃ©taire</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Principal</div>
      <a class="nav-item active" href="dashboard.html"><span class="nav-icon">ğŸ“Š</span>Dashboard</a>
      <a class="nav-item" href="orders.html"><span class="nav-icon">ğŸ§¾</span>Commandes<span class="nav-badge" id="pending-badge">0</span></a>
      <a class="nav-item" href="reservations.html"><span class="nav-icon">ğŸ“…</span>RÃ©servations</a>
      <div class="nav-section">Gestion</div>
      <a class="nav-item" href="inventory.html"><span class="nav-icon">ğŸ“¦</span>Inventaire</a>
      <a class="nav-item" href="matches.html"><span class="nav-icon">âš½</span>Matchs</a>
      <a class="nav-item" href="customers.html"><span class="nav-icon">ğŸ‘¥</span>Clients</a>
      <a class="nav-item" href="staff.html"><span class="nav-icon">ğŸ‘¤</span>Personnel</a>
      <a class="nav-item" href="archive.html"><span class="nav-icon">ğŸ—‚ï¸</span>Archives</a>
      <div class="nav-section">Site</div>
      <a class="nav-item" href="../../public/home.html" target="_blank"><span class="nav-icon">ğŸŒ</span>Voir le site</a>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="doLogout()">ğŸšª DÃ©connexion</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main-content">
    <header class="main-header">
      <button class="sidebar-toggle" onclick="openSidebar()">â˜°</button>
      <h1>Dashboard <em>PropriÃ©taire</em></h1>
      <div class="header-actions">
        <span class="live-dot"></span>
        <span style="font-size:.52rem;letter-spacing:.15em;color:var(--gray)" id="live-txt">En direct</span>
      </div>
    </header>

    <div class="main-body">
      <!-- STATS -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ§¾</div>
          <div class="stat-val" id="stat-orders-today">0</div>
          <div class="stat-label">Commandes aujourd'hui</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div><span class="stat-val" id="stat-revenue-today">0</span><span class="stat-da">DA</span></div>
          <div class="stat-label">Revenus aujourd'hui</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â³</div>
          <div class="stat-val" id="stat-pending">0</div>
          <div class="stat-label">En attente</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“…</div>
          <div class="stat-val" id="stat-resa-today">0</div>
          <div class="stat-label">RÃ©servations aujourd'hui</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div><span class="stat-val" id="stat-paid">0</span><span class="stat-da">DA</span></div>
          <div class="stat-label">Total encaissÃ©</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âŒ</div>
          <div><span class="stat-val" id="stat-unpaid">0</span><span class="stat-da">DA</span></div>
          <div class="stat-label">Non encaissÃ©</div>
        </div>
      </div>

      <!-- RECENT ORDERS -->
      <div class="table-card" style="margin-bottom:24px">
        <div class="table-header">
          <div class="table-title">Commandes <em>rÃ©centes</em></div>
          <a href="orders.html" class="action-btn gold">Voir tout â†’</a>
        </div>
        <div class="orders-list" id="recent-orders">
          <div class="empty-state"><div class="empty-icon">ğŸ§¾</div><div class="empty-msg">Aucune commande aujourd'hui.</div></div>
        </div>
      </div>

      <!-- RECENT RESERVATIONS -->
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">RÃ©servations <em>rÃ©centes</em></div>
          <a href="reservations.html" class="action-btn gold">Voir tout â†’</a>
        </div>
        <div class="orders-list" id="recent-resas">
          <div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-msg">Aucune rÃ©servation aujourd'hui.</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from '../../firebase-config.js';
import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { collection, query, where, orderBy, onSnapshot, Timestamp, doc, getDoc }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Auth guard
onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href = '../login.html'; return; }
  const snap = await getDoc(doc(db, 'users', user.uid));
  if (!snap.exists() || snap.data().role !== 'owner') { window.location.href = '../login.html'; }
});

// Sidebar
window.openSidebar = () => { document.getElementById('sidebar').classList.add('open'); document.getElementById('overlay').classList.add('show'); };
window.closeSidebar = () => { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show'); };

// Logout
window.doLogout = async () => { await signOut(auth); window.location.href = '../login.html'; };

// Today range
function todayRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const end = new Date(start.getTime() + 86400000);
  return { start: Timestamp.fromDate(start), end: Timestamp.fromDate(end) };
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function statusBadge(s) {
  const map = { pending:'badge-pending', preparing:'badge-preparing', ready:'badge-ready', done:'badge-done', confirmed:'badge-confirmed', cancelled:'badge-cancelled', arrived:'badge-arrived' };
  const labels = { pending:'En attente', preparing:'En prÃ©paration', ready:'PrÃªt', done:'TerminÃ©', confirmed:'ConfirmÃ©', cancelled:'AnnulÃ©', arrived:'ArrivÃ©' };
  return `<span class="badge ${map[s]||'badge-pending'}">${labels[s]||s}</span>`;
}

function paidBadge(paid) {
  return paid
    ? `<span class="badge badge-paid">âœ… PayÃ©</span>`
    : `<span class="badge badge-unpaid">âŒ Non payÃ©</span>`;
}

function timeAgo(ts) {
  if (!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleTimeString('fr-DZ', { hour: '2-digit', minute: '2-digit' });
}

// Listen orders
const { start, end } = todayRange();
const ordersQ = query(collection(db,'orders'), where('createdAt','>=',start), where('createdAt','<',end), orderBy('createdAt','desc'));
onSnapshot(ordersQ, snap => {
  const orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  // Stats
  document.getElementById('stat-orders-today').textContent = orders.length;
  const totalRev = orders.reduce((s,o) => s + (o.total||0), 0);
  document.getElementById('stat-revenue-today').textContent = totalRev;
  const pending = orders.filter(o => o.status === 'pending').length;
  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('pending-badge').textContent = pending;
  const paid = orders.filter(o => o.paid).reduce((s,o) => s + (o.total||0), 0);
  document.getElementById('stat-paid').textContent = paid;
  const unpaid = orders.filter(o => !o.paid).reduce((s,o) => s + (o.total||0), 0);
  document.getElementById('stat-unpaid').textContent = unpaid;

  // Recent list
  const el = document.getElementById('recent-orders');
  if (orders.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ§¾</div><div class="empty-msg">Aucune commande aujourd\'hui.</div></div>';
    return;
  }
  el.innerHTML = orders.slice(0,5).map(o => `
    <div class="order-card">
      <div class="order-card-top">
        <span class="order-id">${o.orderId}</span>
        <span class="order-client">${o.clientName}</span>
        <span class="order-time">${timeAgo(o.createdAt)}</span>
        ${statusBadge(o.status)}
        ${paidBadge(o.paid)}
      </div>
      <div class="order-items-list">${(o.items||[]).map(i=>`${i.name} Ã—${i.qty}`).join(' Â· ')}</div>
      <div class="order-card-bottom">
        <span class="order-total">${o.total}<span class="da">DA</span></span>
        <a href="orders.html" class="action-btn">GÃ©rer â†’</a>
      </div>
    </div>`).join('');
});

// Listen reservations
const resaQ = query(collection(db,'reservations'), where('createdAt','>=',start), where('createdAt','<',end), orderBy('createdAt','desc'));
onSnapshot(resaQ, snap => {
  const resas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  document.getElementById('stat-resa-today').textContent = resas.length;
  const el = document.getElementById('recent-resas');
  if (resas.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-msg">Aucune rÃ©servation aujourd\'hui.</div></div>';
    return;
  }
  el.innerHTML = resas.slice(0,5).map(r => `
    <div class="order-card">
      <div class="order-card-top">
        <span class="order-id">${r.reservationId}</span>
        <span class="order-client">${r.clientName}</span>
        <span class="order-time">${r.time}</span>
        ${statusBadge(r.status)}
      </div>
      <div class="order-items-list">${r.guests} personne(s) Â· Chicha: ${r.hookah||'â€”'}</div>
      <div class="order-card-bottom">
        <span style="font-size:.6rem;color:var(--gray)">${r.date}</span>
        <a href="reservations.html" class="action-btn">GÃ©rer â†’</a>
      </div>
    </div>`).join('');
});
</script>
</body>
</html>