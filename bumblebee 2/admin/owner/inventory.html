<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bumblebee ‚Äî Inventaire</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Montserrat:wght@200;300;400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="../admin.css"/>
<style>
.inv-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px}
@media(max-width:900px){.inv-grid{grid-template-columns:1fr}}

.inv-card{background:var(--dark);border:1px solid var(--border)}
.inv-card-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.inv-card-title{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:300}
.inv-card-title em{color:var(--gold);font-style:italic}
.inv-body{padding:20px 24px}

/* CHICHA STOCK */
.chicha-stock-item{padding:20px 0;border-bottom:1px solid var(--border)}
.chicha-stock-item:last-child{border-bottom:none}
.cs-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:12px;flex-wrap:wrap}
.cs-name{font-size:.72rem;letter-spacing:.08em;color:var(--white)}
.cs-weight{font-family:'Cormorant Garamond',serif;font-size:1.6rem;color:var(--gold);font-weight:300}
.cs-unit{font-size:.5rem;letter-spacing:.25em;text-transform:uppercase;color:var(--gray);margin-left:4px}
.cs-bar-wrap{margin-bottom:12px}
.cs-bar-labels{display:flex;justify-content:space-between;font-size:.5rem;letter-spacing:.15em;color:var(--gray);margin-bottom:6px}
.cs-bar{height:6px;background:rgba(255,255,255,.06);border-radius:0;overflow:hidden}
.cs-bar-fill{height:100%;transition:width .6s ease,background .3s}
.cs-controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.cs-input{width:90px;background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--white);padding:9px 12px;font-family:'Montserrat',sans-serif;font-size:.65rem;outline:none;transition:border-color .3s;border-radius:0;text-align:center}
.cs-input:focus{border-color:rgba(201,168,76,.4)}
.cs-label{font-size:.5rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gray)}
.cs-alert{display:flex;align-items:center;gap:8px;padding:10px 14px;font-size:.56rem;letter-spacing:.1em;margin-top:12px}
.cs-alert.low{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);color:#f59e0b}
.cs-alert.empty{background:rgba(229,57,53,.08);border:1px solid rgba(229,57,53,.2);color:#e05252}
.cs-alert.ok{background:rgba(37,211,102,.06);border:1px solid rgba(37,211,102,.15);color:#25d366}

/* DRINKS STOCK */
.drink-item{display:flex;align-items:center;gap:12px;padding:13px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.drink-item:last-child{border-bottom:none}
.drink-name{flex:1;font-size:.68rem;letter-spacing:.07em;color:var(--white)}
.drink-category{font-size:.48rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gray);margin-top:2px}
.drink-qty{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--gold);white-space:nowrap;min-width:60px;text-align:right}
.drink-qty-unit{font-size:.48rem;color:var(--gray);letter-spacing:.15em;text-transform:uppercase;margin-left:3px}
.drink-controls{display:flex;gap:4px}
.dq-btn{width:28px;height:28px;background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.2);color:var(--gold);font-size:.9rem;display:flex;align-items:center;justify-content:center;transition:all .3s;font-family:'Montserrat',sans-serif}
.dq-btn:hover{background:rgba(201,168,76,.18)}
.dq-del{background:rgba(229,57,53,.08);border-color:rgba(229,57,53,.2);color:#e05252}
.dq-del:hover{background:rgba(229,57,53,.18)}
.drink-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.status-ok{background:#25d366}
.status-low{background:#f59e0b}
.status-empty{background:#e05252}

/* ADD DRINK FORM */
.add-drink-form{background:rgba(201,168,76,.03);border:1px solid rgba(201,168,76,.1);padding:20px;margin-top:16px}
.add-drink-title{font-size:.52rem;letter-spacing:.32em;text-transform:uppercase;color:var(--gold);margin-bottom:14px}
.add-form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
@media(max-width:480px){.add-form-row{grid-template-columns:1fr}}
.add-form-row3{display:grid;grid-template-columns:1fr 1fr 80px;gap:10px;margin-bottom:10px}
@media(max-width:480px){.add-form-row3{grid-template-columns:1fr}}
.add-btn-full{width:100%;padding:12px;background:var(--gold);border:none;color:var(--black);font-family:'Montserrat',sans-serif;font-size:.56rem;font-weight:500;letter-spacing:.3em;text-transform:uppercase;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px}
.add-btn-full:hover{background:var(--gold-light)}

/* STATS ROW */
.inv-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;margin-bottom:24px}
</style>
</head>
<body>
<div class="sidebar-overlay" id="overlay" onclick="closeSidebar()"></div>
<div class="toast" id="toast"></div>

<div class="admin-layout">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo">Bumble<span>bee</span></div>
      <div class="role-badge">üëë Propri√©taire</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Principal</div>
      <a class="nav-item" href="dashboard.html"><span class="nav-icon">üìä</span>Dashboard</a>
      <a class="nav-item" href="orders.html"><span class="nav-icon">üßæ</span>Commandes</a>
      <a class="nav-item" href="reservations.html"><span class="nav-icon">üìÖ</span>R√©servations</a>
      <div class="nav-section">Gestion</div>
      <a class="nav-item active" href="inventory.html"><span class="nav-icon">üì¶</span>Inventaire</a>
      <a class="nav-item" href="matches.html"><span class="nav-icon">‚öΩ</span>Matchs</a>
      <a class="nav-item" href="customers.html"><span class="nav-icon">üë•</span>Clients</a>
      <a class="nav-item" href="staff.html"><span class="nav-icon">üë§</span>Personnel</a>
      <a class="nav-item" href="archive.html"><span class="nav-icon">üóÇÔ∏è</span>Archives</a>
      <div class="nav-section">Site</div>
      <a class="nav-item" href="../../public/home.html" target="_blank"><span class="nav-icon">üåê</span>Voir le site</a>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="doLogout()">üö™ D√©connexion</button>
    </div>
  </aside>

  <div class="main-content">
    <header class="main-header">
      <button class="sidebar-toggle" onclick="openSidebar()">‚ò∞</button>
      <h1>Gestion de l'<em>inventaire</em></h1>
      <div class="header-actions">
        <span style="font-size:.52rem;letter-spacing:.15em;color:var(--gray)" id="last-update">‚Äî</span>
      </div>
    </header>

    <div class="main-body">

      <!-- STATS -->
      <div class="inv-stats">
        <div class="stat-card"><div class="stat-icon">üçé</div><div><span class="stat-val" id="stat-apple">0</span><span class="stat-da">g</span></div><div class="stat-label">Stock Pomme</div></div>
        <div class="stat-card"><div class="stat-icon">üåø</div><div><span class="stat-val" id="stat-mint">0</span><span class="stat-da">g</span></div><div class="stat-label">Stock Menthe</div></div>
        <div class="stat-card"><div class="stat-icon">ü•§</div><div class="stat-val" id="stat-drinks">0</div><div class="stat-label">R√©f√©rences boissons</div></div>
        <div class="stat-card"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-val" id="stat-low">0</div><div class="stat-label">Stock faible</div></div>
      </div>

      <div class="inv-grid">

        <!-- CHICHA STOCK -->
        <div class="inv-card">
          <div class="inv-card-header">
            <div class="inv-card-title">ü™Ñ Stock <em>Chicha</em></div>
            <button class="action-btn gold" onclick="saveChicha()">üíæ Enregistrer</button>
          </div>
          <div class="inv-body">

            <!-- APPLE -->
            <div class="chicha-stock-item">
              <div class="cs-top">
                <div>
                  <div style="font-size:.5rem;letter-spacing:.35em;text-transform:uppercase;color:var(--gold);margin-bottom:4px">üçé Pomme</div>
                  <div class="cs-name">Chicha Pomme Fra√Æche</div>
                </div>
                <div><span class="cs-weight" id="apple-display">0</span><span class="cs-unit">g</span></div>
              </div>
              <div class="cs-bar-wrap">
                <div class="cs-bar-labels">
                  <span>0g</span><span>Stock critique: 200g</span><span id="apple-max-lbl">1000g</span>
                </div>
                <div class="cs-bar"><div class="cs-bar-fill" id="apple-bar" style="width:0%;background:#25d366"></div></div>
              </div>
              <div class="cs-controls">
                <div>
                  <div class="cs-label" style="margin-bottom:5px">Stock actuel (g)</div>
                  <input type="number" class="cs-input" id="apple-stock" placeholder="0" min="0" oninput="updateChichaDisplay('apple')"/>
                </div>
                <div>
                  <div class="cs-label" style="margin-bottom:5px">Stock max (g)</div>
                  <input type="number" class="cs-input" id="apple-max" placeholder="1000" min="0" oninput="updateChichaDisplay('apple')"/>
                </div>
                <div>
                  <div class="cs-label" style="margin-bottom:5px">Alerte (g)</div>
                  <input type="number" class="cs-input" id="apple-alert" placeholder="200" min="0"/>
                </div>
              </div>
              <div id="apple-alert-box"></div>
            </div>

            <!-- MINT -->
            <div class="chicha-stock-item">
              <div class="cs-top">
                <div>
                  <div style="font-size:.5rem;letter-spacing:.35em;text-transform:uppercase;color:#25d366;margin-bottom:4px">üåø Menthe</div>
                  <div class="cs-name">Chicha Menthe Fra√Æche</div>
                </div>
                <div><span class="cs-weight" id="mint-display">0</span><span class="cs-unit">g</span></div>
              </div>
              <div class="cs-bar-wrap">
                <div class="cs-bar-labels">
                  <span>0g</span><span>Stock critique: 200g</span><span id="mint-max-lbl">1000g</span>
                </div>
                <div class="cs-bar"><div class="cs-bar-fill" id="mint-bar" style="width:0%;background:#25d366"></div></div>
              </div>
              <div class="cs-controls">
                <div>
                  <div class="cs-label" style="margin-bottom:5px">Stock actuel (g)</div>
                  <input type="number" class="cs-input" id="mint-stock" placeholder="0" min="0" oninput="updateChichaDisplay('mint')"/>
                </div>
                <div>
                  <div class="cs-label" style="margin-bottom:5px">Stock max (g)</div>
                  <input type="number" class="cs-input" id="mint-max" placeholder="1000" min="0" oninput="updateChichaDisplay('mint')"/>
                </div>
                <div>
                  <div class="cs-label" style="margin-bottom:5px">Alerte (g)</div>
                  <input type="number" class="cs-input" id="mint-alert" placeholder="200" min="0"/>
                </div>
              </div>
              <div id="mint-alert-box"></div>
            </div>

          </div>
        </div>

        <!-- DRINKS STOCK -->
        <div class="inv-card">
          <div class="inv-card-header">
            <div class="inv-card-title">ü•§ Stock <em>Boissons</em></div>
          </div>
          <div class="inv-body">
            <div id="drinks-list"></div>

            <!-- ADD DRINK -->
            <div class="add-drink-form">
              <div class="add-drink-title">‚ûï Ajouter une boisson</div>
              <div class="add-form-row">
                <div class="a-form-group" style="margin-bottom:0">
                  <label class="a-form-label">Nom</label>
                  <input type="text" class="a-form-input" id="new-drink-name" placeholder="Ex: Pepsi"/>
                </div>
                <div class="a-form-group" style="margin-bottom:0">
                  <label class="a-form-label">Cat√©gorie</label>
                  <select class="a-form-select" id="new-drink-cat">
                    <option value="Boisson gazeuse">Boisson gazeuse</option>
                    <option value="Jus de fruits">Jus de fruits</option>
                    <option value="Eau min√©rale">Eau min√©rale</option>
                    <option value="Boisson chaude">Boisson chaude</option>
                    <option value="Boisson √©nergisante">Boisson √©nergisante</option>
                    <option value="Autre">Autre</option>
                  </select>
                </div>
              </div>
              <div class="add-form-row3" style="margin-top:10px">
                <div class="a-form-group" style="margin-bottom:0">
                  <label class="a-form-label">Prix (DA)</label>
                  <input type="number" class="a-form-input" id="new-drink-price" placeholder="80" min="0"/>
                </div>
                <div class="a-form-group" style="margin-bottom:0">
                  <label class="a-form-label">Quantit√©</label>
                  <input type="number" class="a-form-input" id="new-drink-qty" placeholder="24" min="0"/>
                </div>
                <div class="a-form-group" style="margin-bottom:0">
                  <label class="a-form-label">Alerte</label>
                  <input type="number" class="a-form-input" id="new-drink-alert" placeholder="5" min="0"/>
                </div>
              </div>
              <button class="add-btn-full" style="margin-top:12px" onclick="addDrink()">‚ûï Ajouter au stock</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from '../../firebase-config.js';
import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { doc, getDoc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, getDocs }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href = '../login.html'; return; }
  const snap = await getDoc(doc(db,'users',user.uid));
  if (!snap.exists() || snap.data().role !== 'owner') window.location.href = '../login.html';
});

window.openSidebar=()=>{document.getElementById('sidebar').classList.add('open');document.getElementById('overlay').classList.add('show');};
window.closeSidebar=()=>{document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('show');};
window.doLogout=async()=>{await signOut(auth);window.location.href='../login.html';};

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// ‚îÄ‚îÄ‚îÄ CHICHA ‚îÄ‚îÄ‚îÄ
window.updateChichaDisplay = function(type) {
  const stock = parseFloat(document.getElementById(`${type}-stock`).value)||0;
  const max   = parseFloat(document.getElementById(`${type}-max`).value)||1000;
  const alert = parseFloat(document.getElementById(`${type}-alert`).value)||200;
  const pct   = Math.min(100, (stock/max)*100);

  document.getElementById(`${type}-display`).textContent = stock;
  document.getElementById(`${type}-max-lbl`).textContent = max+'g';

  const bar = document.getElementById(`${type}-bar`);
  bar.style.width = pct+'%';
  bar.style.background = stock<=0?'#e05252':stock<=alert?'#f59e0b':'#25d366';

  const alertBox = document.getElementById(`${type}-alert-box`);
  if(stock<=0) alertBox.innerHTML=`<div class="cs-alert empty">‚õî Stock √©puis√© ! R√©approvisionnement urgent.</div>`;
  else if(stock<=alert) alertBox.innerHTML=`<div class="cs-alert low">‚ö†Ô∏è Stock faible ‚Äî ${stock}g restants. Pensez √† r√©approvisionner.</div>`;
  else alertBox.innerHTML=`<div class="cs-alert ok">‚úÖ Stock suffisant ‚Äî ${stock}g disponibles.</div>`;

  // Update stat cards
  document.getElementById('stat-'+type).textContent = stock;
};

window.saveChicha = async function() {
  const data = {
    apple: { stock: parseFloat(document.getElementById('apple-stock').value)||0, max: parseFloat(document.getElementById('apple-max').value)||1000, alert: parseFloat(document.getElementById('apple-alert').value)||200 },
    mint:  { stock: parseFloat(document.getElementById('mint-stock').value)||0,  max: parseFloat(document.getElementById('mint-max').value)||1000,  alert: parseFloat(document.getElementById('mint-alert').value)||200 },
    updatedAt: new Date().toISOString()
  };
  await setDoc(doc(db,'inventory','chicha'), data);
  showToast('‚úÖ Stock chicha enregistr√© !');
  document.getElementById('last-update').textContent = 'Mis √† jour: '+new Date().toLocaleTimeString('fr-DZ',{hour:'2-digit',minute:'2-digit'});
};

// Load chicha
onSnapshot(doc(db,'inventory','chicha'), snap => {
  if (!snap.exists()) return;
  const d = snap.data();
  ['apple','mint'].forEach(type => {
    if(d[type]) {
      document.getElementById(`${type}-stock`).value = d[type].stock||0;
      document.getElementById(`${type}-max`).value   = d[type].max||1000;
      document.getElementById(`${type}-alert`).value = d[type].alert||200;
      window.updateChichaDisplay(type);
    }
  });
});

// ‚îÄ‚îÄ‚îÄ DRINKS ‚îÄ‚îÄ‚îÄ
let drinks = [];

function renderDrinks() {
  const el = document.getElementById('drinks-list');
  let lowCount = 0;
  if(drinks.length===0){el.innerHTML='<div class="empty-state" style="padding:24px 0"><div class="empty-icon" style="font-size:1.5rem">ü•§</div><div class="empty-msg">Aucune boisson. Ajoutez-en ci-dessous.</div></div>';return;}
  el.innerHTML = drinks.map(d => {
    const alert = d.alert||5;
    const isEmpty = d.qty<=0;
    const isLow = d.qty>0 && d.qty<=alert;
    if(isEmpty||isLow) lowCount++;
    return `<div class="drink-item">
      <div class="drink-status ${isEmpty?'status-empty':isLow?'status-low':'status-ok'}"></div>
      <div style="flex:1">
        <div class="drink-name">${d.name}</div>
        <div class="drink-category">${d.category} ¬∑ ${d.price} DA</div>
      </div>
      <div class="drink-qty">${d.qty}<span class="drink-qty-unit">unit√©s</span></div>
      <div class="drink-controls">
        <button class="dq-btn" onclick="updateDrinkQty('${d.id}',-1)">‚àí</button>
        <button class="dq-btn" onclick="updateDrinkQty('${d.id}',1)">+</button>
        <button class="dq-btn dq-del" onclick="deleteDrink('${d.id}')">‚úï</button>
      </div>
    </div>`;
  }).join('');
  document.getElementById('stat-drinks').textContent = drinks.length;
  document.getElementById('stat-low').textContent = lowCount;
}

window.addDrink = async function() {
  const name  = document.getElementById('new-drink-name').value.trim();
  const cat   = document.getElementById('new-drink-cat').value;
  const price = parseFloat(document.getElementById('new-drink-price').value)||0;
  const qty   = parseInt(document.getElementById('new-drink-qty').value)||0;
  const alert = parseInt(document.getElementById('new-drink-alert').value)||5;
  if(!name){showToast('‚ö†Ô∏è Entrez un nom pour la boisson');return;}
  await addDoc(collection(db,'inventory_drinks'),{name,category:cat,price,qty,alert,createdAt:new Date().toISOString()});
  document.getElementById('new-drink-name').value='';
  document.getElementById('new-drink-price').value='';
  document.getElementById('new-drink-qty').value='';
  showToast('‚úÖ Boisson ajout√©e !');
};

window.updateDrinkQty = async function(id, delta) {
  const drink = drinks.find(d=>d.id===id);
  if(!drink) return;
  const newQty = Math.max(0, drink.qty+delta);
  await updateDoc(doc(db,'inventory_drinks',id),{qty:newQty});
  showToast(delta>0?'‚ûï Quantit√© augment√©e':'‚ûñ Quantit√© r√©duite');
};

window.deleteDrink = async function(id) {
  if(!confirm('Supprimer cette boisson du stock ?')) return;
  await deleteDoc(doc(db,'inventory_drinks',id));
  showToast('üóë Boisson supprim√©e');
};

// Real-time drinks listener
onSnapshot(collection(db,'inventory_drinks'), snap => {
  drinks = snap.docs.map(d=>({id:d.id,...d.data()}));
  drinks.sort((a,b)=>a.name.localeCompare(b.name));
  renderDrinks();
});
</script>
</body>
</html>