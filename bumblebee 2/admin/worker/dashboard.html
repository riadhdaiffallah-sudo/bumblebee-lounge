<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bumblebee â€” Dashboard EmployÃ©</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Montserrat:wght@200;300;400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="../admin.css"/>
</head>
<body>
<div class="sidebar-overlay" id="overlay" onclick="closeSidebar()"></div>
<div class="toast" id="toast"></div>

<div class="admin-layout">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo">Bumble<span>bee</span></div>
      <div class="role-badge">ğŸ‘¤ EmployÃ©</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Aujourd'hui</div>
      <a class="nav-item active" href="dashboard.html"><span class="nav-icon">ğŸ“Š</span>Dashboard</a>
      <a class="nav-item" href="orders.html"><span class="nav-icon">ğŸ§¾</span>Commandes<span class="nav-badge" id="pending-badge">0</span></a>
      <a class="nav-item" href="reservations.html"><span class="nav-icon">ğŸ“…</span>RÃ©servations</a>
      <div class="nav-section">Site</div>
      <a class="nav-item" href="../../public/home.html" target="_blank"><span class="nav-icon">ğŸŒ</span>Voir le site</a>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="doLogout()">ğŸšª DÃ©connexion</button>
    </div>
  </aside>

  <div class="main-content">
    <header class="main-header">
      <button class="sidebar-toggle" onclick="openSidebar()">â˜°</button>
      <h1>Dashboard <em>EmployÃ©</em></h1>
      <div class="header-actions">
        <span class="live-dot"></span>
        <span style="font-size:.52rem;letter-spacing:.15em;color:var(--gray)" id="date-display"></span>
      </div>
    </header>

    <div class="main-body">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">ğŸ§¾</div><div class="stat-val" id="stat-orders">0</div><div class="stat-label">Commandes du jour</div></div>
        <div class="stat-card"><div class="stat-icon">â³</div><div class="stat-val" id="stat-pending">0</div><div class="stat-label">En attente</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ”¥</div><div class="stat-val" id="stat-preparing">0</div><div class="stat-label">En prÃ©paration</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ“…</div><div class="stat-val" id="stat-resas">0</div><div class="stat-label">RÃ©servations du jour</div></div>
      </div>

      <!-- PENDING ORDERS - priority view -->
      <div class="table-card" style="margin-bottom:24px">
        <div class="table-header">
          <div class="table-title">Commandes <em>en attente</em></div>
          <a href="orders.html" class="action-btn gold">Toutes â†’</a>
        </div>
        <div class="orders-list" id="pending-orders">
          <div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-msg">Aucune commande en attente ğŸ‰</div></div>
        </div>
      </div>

      <!-- TODAY RESERVATIONS -->
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">RÃ©servations <em>aujourd'hui</em></div>
          <a href="reservations.html" class="action-btn gold">Toutes â†’</a>
        </div>
        <div class="orders-list" id="today-resas">
          <div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-msg">Aucune rÃ©servation aujourd'hui.</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from '../../firebase-config.js';
import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { collection, query, where, orderBy, onSnapshot, Timestamp, doc, updateDoc, getDoc }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

onAuthStateChanged(auth, user => {
  if (!user) window.location.href = '../login.html';
});

window.openSidebar=()=>{document.getElementById('sidebar').classList.add('open');document.getElementById('overlay').classList.add('show');};
window.closeSidebar=()=>{document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('show');};
window.doLogout=async()=>{await signOut(auth);window.location.href='../login.html';};

// Date display
const now=new Date();
document.getElementById('date-display').textContent=now.toLocaleDateString('fr-DZ',{weekday:'long',day:'numeric',month:'long'});

function todayRange(){
  const s=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  return{start:Timestamp.fromDate(s),end:Timestamp.fromDate(new Date(s.getTime()+86400000))};
}

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

function statusBadge(s){
  const map={pending:'badge-pending',preparing:'badge-preparing',ready:'badge-ready',done:'badge-done'};
  const labels={pending:'En attente',preparing:'En prÃ©paration',ready:'PrÃªt âœ“',done:'TerminÃ©'};
  return `<span class="badge ${map[s]||'badge-pending'}">${labels[s]||s}</span>`;
}

const {start,end}=todayRange();

// Orders listener
const ordQ=query(collection(db,'orders'),where('createdAt','>=',start),where('createdAt','<',end),orderBy('createdAt','asc'));
onSnapshot(ordQ,snap=>{
  const orders=snap.docs.map(d=>({id:d.id,...d.data()}));
  document.getElementById('stat-orders').textContent=orders.length;
  const pending=orders.filter(o=>o.status==='pending');
  const preparing=orders.filter(o=>o.status==='preparing');
  document.getElementById('stat-pending').textContent=pending.length;
  document.getElementById('stat-preparing').textContent=preparing.length;
  document.getElementById('pending-badge').textContent=pending.length;

  const el=document.getElementById('pending-orders');
  const active=orders.filter(o=>o.status==='pending'||o.status==='preparing');
  if(active.length===0){el.innerHTML='<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-msg">Aucune commande en attente ğŸ‰</div></div>';return;}
  el.innerHTML=active.map(o=>`
    <div class="order-card">
      <div class="order-card-top">
        <span class="order-id">${o.orderId}</span>
        <span class="order-client">${o.clientName}</span>
        ${statusBadge(o.status)}
        ${o.paid?'<span class="badge badge-paid">âœ… PayÃ©</span>':'<span class="badge badge-unpaid">âŒ Non payÃ©</span>'}
      </div>
      <div class="order-items-list">${(o.items||[]).map(i=>`â€¢ ${i.name} Ã—${i.qty}`).join('<br>')}</div>
      <div class="order-card-bottom">
        <span class="order-total">${o.total}<span class="da">DA</span></span>
        <button class="action-btn green" onclick="markPreparing('${o.id}')" ${o.status==='preparing'?'disabled':''}>
          ${o.status==='preparing'?'En cours...':'ğŸ”¥ PrÃ©parer'}
        </button>
        <button class="action-btn gold" onclick="markReady('${o.id}')">âœ… PrÃªt</button>
        <button class="action-btn ${o.paid?'':'green'}" onclick="togglePaid('${o.id}',${o.paid})">
          ${o.paid?'Annuler paiement':'ğŸ’µ Encaisser'}
        </button>
      </div>
    </div>`).join('');
});

window.markPreparing=async id=>{await updateDoc(doc(db,'orders',id),{status:'preparing'});showToast('ğŸ”¥ En prÃ©paration');};
window.markReady=async id=>{await updateDoc(doc(db,'orders',id),{status:'ready'});showToast('âœ… Commande prÃªte !');};
window.togglePaid=async(id,paid)=>{
  const newPaid=!paid;
  await updateDoc(doc(db,'orders',id),{paid:newPaid});
  showToast(newPaid?'âœ… Paiement encaissÃ© !':'Paiement annulÃ©');
};

// Reservations listener
const resaQ=query(collection(db,'reservations'),where('createdAt','>=',start),where('createdAt','<',end),orderBy('createdAt','asc'));
onSnapshot(resaQ,snap=>{
  const resas=snap.docs.map(d=>({id:d.id,...d.data()}));
  document.getElementById('stat-resas').textContent=resas.length;
  const el=document.getElementById('today-resas');
  if(resas.length===0){el.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-msg">Aucune rÃ©servation aujourd\'hui.</div></div>';return;}
  const statusMap={pending:'badge-pending',confirmed:'badge-confirmed',cancelled:'badge-cancelled',arrived:'badge-arrived'};
  const labelMap={pending:'En attente',confirmed:'ConfirmÃ©e',cancelled:'AnnulÃ©e',arrived:'ArrivÃ©'};
  el.innerHTML=resas.map(r=>`
    <div class="order-card">
      <div class="order-card-top">
        <span class="order-id">${r.reservationId}</span>
        <span class="order-client">${r.clientName}</span>
        <span class="order-time">${r.time}</span>
        <span class="badge ${statusMap[r.status]||'badge-pending'}">${labelMap[r.status]||r.status}</span>
      </div>
      <div class="order-items-list">ğŸ‘¥ ${r.guests} pers. Â· ğŸª„ ${r.hookah||'â€”'}</div>
      <div class="order-card-bottom">
        <button class="action-btn gold" onclick="markArrived('${r.id}')">ğŸ‰ ArrivÃ©</button>
      </div>
    </div>`).join('');
});

window.markArrived=async id=>{await updateDoc(doc(db,'reservations',id),{status:'arrived'});showToast('ğŸ‰ Client arrivÃ© !');};
</script>
</body>
</html>